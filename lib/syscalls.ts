// macOS syscall number to name mappings (subset of common syscalls)
// Full list at: /usr/include/sys/syscall.h
export const SYSCALL_NAMES: Record<number, string> = {
  1: "exit",
  2: "fork",
  3: "read",
  4: "write",
  5: "open",
  6: "close",
  7: "wait4",
  9: "link",
  10: "unlink",
  12: "chdir",
  13: "fchdir",
  14: "mknod",
  15: "chmod",
  16: "chown",
  18: "getfsstat",
  20: "getpid",
  23: "setuid",
  24: "getuid",
  25: "geteuid",
  26: "ptrace",
  27: "recvmsg",
  28: "sendmsg",
  29: "recvfrom",
  30: "accept",
  31: "getpeername",
  32: "getsockname",
  33: "access",
  34: "chflags",
  35: "fchflags",
  36: "sync",
  37: "kill",
  39: "getppid",
  41: "dup",
  42: "pipe",
  43: "getegid",
  46: "sigaction",
  47: "getgid",
  48: "sigprocmask",
  49: "getlogin",
  50: "setlogin",
  51: "acct",
  52: "sigpending",
  53: "sigaltstack",
  54: "ioctl",
  55: "reboot",
  56: "revoke",
  57: "symlink",
  58: "readlink",
  59: "execve",
  60: "umask",
  61: "chroot",
  65: "msync",
  66: "vfork",
  73: "munmap",
  74: "mprotect",
  75: "madvise",
  78: "mincore",
  79: "getgroups",
  80: "setgroups",
  81: "getpgrp",
  82: "setpgid",
  83: "setitimer",
  85: "swapon",
  86: "getitimer",
  89: "getdtablesize",
  90: "dup2",
  92: "fcntl",
  93: "select",
  95: "fsync",
  96: "setpriority",
  97: "socket",
  98: "connect",
  100: "getpriority",
  104: "bind",
  105: "setsockopt",
  106: "listen",
  111: "sigsuspend",
  116: "gettimeofday",
  117: "getrusage",
  118: "getsockopt",
  120: "readv",
  121: "writev",
  122: "settimeofday",
  123: "fchown",
  124: "fchmod",
  126: "setreuid",
  127: "setregid",
  128: "rename",
  131: "flock",
  132: "mkfifo",
  133: "sendto",
  134: "shutdown",
  135: "socketpair",
  136: "mkdir",
  137: "rmdir",
  138: "utimes",
  139: "futimes",
  140: "adjtime",
  142: "gethostuuid",
  147: "setsid",
  151: "getpgid",
  152: "setprivexec",
  153: "pread",
  154: "pwrite",
  157: "statfs",
  158: "fstatfs",
  159: "unmount",
  165: "quotactl",
  167: "mount",
  169: "csops",
  170: "csops_audittoken",
  173: "waitid",
  180: "kdebug_typefilter",
  181: "kdebug_trace_string",
  182: "kdebug_trace64",
  183: "kdebug_trace",
  184: "setgid",
  185: "setegid",
  186: "seteuid",
  187: "sigreturn",
  190: "fdatasync",
  191: "stat",
  192: "fstat",
  193: "lstat",
  194: "pathconf",
  195: "fpathconf",
  197: "getrlimit",
  198: "setrlimit",
  199: "getdirentries",
  200: "mmap",
  202: "lseek",
  203: "truncate",
  204: "ftruncate",
  205: "sysctl",
  206: "mlock",
  207: "munlock",
  208: "undelete",
  216: "open_dprotected_np",
  220: "getattrlist",
  221: "setattrlist",
  222: "getdirentriesattr",
  223: "exchangedata",
  225: "searchfs",
  226: "delete",
  227: "copyfile",
  228: "fgetattrlist",
  229: "fsetattrlist",
  230: "poll",
  234: "getxattr",
  235: "fgetxattr",
  236: "setxattr",
  237: "fsetxattr",
  238: "removexattr",
  239: "fremovexattr",
  240: "listxattr",
  241: "flistxattr",
  242: "fsctl",
  243: "initgroups",
  244: "posix_spawn",
  245: "ffsctl",
  250: "minherit",
  266: "shm_open",
  267: "shm_unlink",
  268: "sem_open",
  269: "sem_close",
  270: "sem_unlink",
  271: "sem_wait",
  272: "sem_trywait",
  273: "sem_post",
  274: "sysctlbyname",
  277: "open_extended",
  278: "umask_extended",
  279: "stat_extended",
  280: "lstat_extended",
  281: "fstat_extended",
  282: "chmod_extended",
  283: "fchmod_extended",
  284: "access_extended",
  285: "settid",
  286: "gettid",
  287: "setsgroups",
  288: "getsgroups",
  289: "setwgroups",
  290: "getwgroups",
  291: "mkfifo_extended",
  292: "mkdir_extended",
  294: "shared_region_check_np",
  296: "vm_pressure_monitor",
  297: "psynch_rw_longrdlock",
  298: "psynch_rw_yieldwrlock",
  299: "psynch_rw_downgrade",
  300: "psynch_rw_upgrade",
  301: "psynch_mutexwait",
  302: "psynch_mutexdrop",
  303: "psynch_cvbroad",
  304: "psynch_cvsignal",
  305: "psynch_cvwait",
  306: "psynch_rw_rdlock",
  307: "psynch_rw_wrlock",
  308: "psynch_rw_unlock",
  309: "psynch_rw_unlock2",
  310: "getsid",
  311: "settid_with_pid",
  312: "psynch_cvclrprepost",
  313: "aio_fsync",
  314: "aio_return",
  315: "aio_suspend",
  316: "aio_cancel",
  317: "aio_error",
  318: "aio_read",
  319: "aio_write",
  320: "lio_listio",
  322: "iopolicysys",
  323: "process_policy",
  324: "mlockall",
  325: "munlockall",
  327: "issetugid",
  328: "__pthread_kill",
  329: "__pthread_sigmask",
  330: "__sigwait",
  331: "__disable_threadsignal",
  332: "__pthread_markcancel",
  333: "__pthread_canceled",
  334: "__semwait_signal",
  336: "proc_info",
  337: "sendfile",
  338: "stat64",
  339: "fstat64",
  340: "lstat64",
  341: "stat64_extended",
  342: "lstat64_extended",
  343: "fstat64_extended",
  344: "getdirentries64",
  345: "statfs64",
  346: "fstatfs64",
  347: "getfsstat64",
  348: "__pthread_chdir",
  349: "__pthread_fchdir",
  350: "audit",
  351: "auditon",
  353: "getauid",
  354: "setauid",
  357: "getaudit_addr",
  358: "setaudit_addr",
  359: "auditctl",
  360: "bsdthread_create",
  361: "bsdthread_terminate",
  362: "kqueue",
  363: "kevent",
  364: "lchown",
  366: "bsdthread_register",
  367: "workq_open",
  368: "workq_kernreturn",
  369: "kevent64",
  370: "__old_semwait_signal",
  371: "__old_semwait_signal_nocancel",
  372: "thread_selfid",
  373: "ledger",
  374: "kevent_qos",
  375: "kevent_id",
  380: "__mac_execve",
  381: "__mac_syscall",
  382: "__mac_get_file",
  383: "__mac_set_file",
  384: "__mac_get_link",
  385: "__mac_set_link",
  386: "__mac_get_proc",
  387: "__mac_set_proc",
  388: "__mac_get_fd",
  389: "__mac_set_fd",
  390: "__mac_get_pid",
  394: "pselect",
  395: "pselect_nocancel",
  396: "read_nocancel",
  397: "write_nocancel",
  398: "open_nocancel",
  399: "close_nocancel",
  400: "wait4_nocancel",
  401: "recvmsg_nocancel",
  402: "sendmsg_nocancel",
  403: "recvfrom_nocancel",
  404: "accept_nocancel",
  405: "msync_nocancel",
  406: "fcntl_nocancel",
  407: "select_nocancel",
  408: "fsync_nocancel",
  409: "connect_nocancel",
  410: "sigsuspend_nocancel",
  411: "readv_nocancel",
  412: "writev_nocancel",
  413: "sendto_nocancel",
  414: "pread_nocancel",
  415: "pwrite_nocancel",
  416: "waitid_nocancel",
  417: "poll_nocancel",
  418: "msgsnd_nocancel",
  419: "msgrcv_nocancel",
  420: "sem_wait_nocancel",
  421: "aio_suspend_nocancel",
  422: "__sigwait_nocancel",
  423: "__semwait_signal_nocancel",
  424: "__mac_mount",
  425: "__mac_get_mount",
  426: "__mac_getfsstat",
  427: "fsgetpath",
  428: "audit_session_self",
  429: "audit_session_join",
  430: "fileport_makeport",
  431: "fileport_makefd",
  432: "audit_session_port",
  433: "pid_suspend",
  434: "pid_resume",
  435: "pid_hibernate",
  436: "pid_shutdown_sockets",
  438: "shared_region_map_and_slide_np",
  439: "kas_info",
  440: "memorystatus_control",
  441: "guarded_open_np",
  442: "guarded_close_np",
  443: "guarded_kqueue_np",
  444: "change_fdguard_np",
  445: "usrctl",
  446: "proc_rlimit_control",
  447: "connectx",
  448: "disconnectx",
  449: "peeloff",
  450: "socket_delegate",
  451: "telemetry",
  452: "proc_uuid_policy",
  453: "memorystatus_get_level",
  454: "system_override",
  455: "vfs_purge",
  456: "sfi_ctl",
  457: "sfi_pidctl",
  458: "coalition",
  459: "coalition_info",
  460: "necp_match_policy",
  461: "getattrlistbulk",
  462: "clonefileat",
  463: "openat",
  464: "openat_nocancel",
  465: "renameat",
  466: "faccessat",
  467: "fchmodat",
  468: "fchownat",
  469: "fstatat",
  470: "fstatat64",
  471: "linkat",
  472: "unlinkat",
  473: "readlinkat",
  474: "symlinkat",
  475: "mkdirat",
  476: "getattrlistat",
  477: "proc_trace_log",
  478: "bsdthread_ctl",
  479: "openbyid_np",
  480: "recvmsg_x",
  481: "sendmsg_x",
  482: "thread_selfusage",
  483: "csrctl",
  484: "guarded_open_dprotected_np",
  485: "guarded_write_np",
  486: "guarded_pwrite_np",
  487: "guarded_writev_np",
  488: "renameatx_np",
  489: "mremap_encrypted",
  490: "netagent_trigger",
  491: "stack_snapshot_with_config",
  492: "microstackshot",
  493: "grab_pgo_data",
  494: "persona",
  499: "work_interval_ctl",
  500: "getentropy",
  501: "necp_open",
  502: "necp_client_action",
  515: "ulock_wait",
  516: "ulock_wake",
  517: "fclonefileat",
  518: "fs_snapshot",
  520: "terminate_with_payload",
  521: "abort_with_payload",
  522: "necp_session_open",
  523: "necp_session_action",
  524: "setattrlistat",
  525: "net_qos_guideline",
  526: "fmount",
  527: "ntp_adjtime",
  528: "ntp_gettime",
  529: "os_fault_with_payload",
  530: "kqueue_workloop_ctl",
  531: "__mach_bridge_remote_time",
  532: "coalition_ledger",
  533: "log_data",
  534: "memorystatus_available_memory",
  540: "shared_region_map_and_slide_2_np",
  541: "pivot_root",
  542: "task_inspect_for_pid",
  543: "task_read_for_pid",
  544: "preadv",
  545: "pwritev",
  546: "preadv_nocancel",
  547: "pwritev_nocancel",
  548: "ulock_wait2",
  549: "proc_info_extended_id",
};

// Open flags
export const O_FLAGS: Record<number, string> = {
  0x0000: "O_RDONLY",
  0x0001: "O_WRONLY",
  0x0002: "O_RDWR",
  0x0004: "O_NONBLOCK",
  0x0008: "O_APPEND",
  0x0010: "O_SHLOCK",
  0x0020: "O_EXLOCK",
  0x0040: "O_ASYNC",
  0x0080: "O_NOFOLLOW",
  0x0100: "O_CREAT",
  0x0200: "O_TRUNC",
  0x0400: "O_EXCL",
  0x8000: "O_EVTONLY",
  0x20000: "O_NOCTTY",
  0x100000: "O_DIRECTORY",
  0x200000: "O_SYMLINK",
  0x400000: "O_DSYNC",
  0x1000000: "O_CLOEXEC",
};

// Access mode mask
const O_ACCMODE = 0x0003;

// mmap protection flags
export const PROT_FLAGS: Record<number, string> = {
  0x00: "PROT_NONE",
  0x01: "PROT_READ",
  0x02: "PROT_WRITE",
  0x04: "PROT_EXEC",
};

// mmap flags
export const MAP_FLAGS: Record<number, string> = {
  0x0000: "MAP_FILE",
  0x0001: "MAP_SHARED",
  0x0002: "MAP_PRIVATE",
  0x0010: "MAP_FIXED",
  0x0020: "MAP_RENAME",
  0x0040: "MAP_NORESERVE",
  0x0080: "MAP_INHERIT",
  0x0100: "MAP_NOEXTEND",
  0x0200: "MAP_HASSEMAPHORE",
  0x0400: "MAP_NOCACHE",
  0x1000: "MAP_ANON",
};

// fcntl commands
export const FCNTL_CMDS: Record<number, string> = {
  0: "F_DUPFD",
  1: "F_GETFD",
  2: "F_SETFD",
  3: "F_GETFL",
  4: "F_SETFL",
  5: "F_GETOWN",
  6: "F_SETOWN",
  7: "F_GETLK",
  8: "F_SETLK",
  9: "F_SETLKW",
  10: "F_SETLKWTIMEOUT",
  40: "F_FLUSH_DATA",
  41: "F_CHKCLEAN",
  42: "F_PREALLOCATE",
  43: "F_SETSIZE",
  44: "F_RDADVISE",
  45: "F_RDAHEAD",
  50: "F_NOCACHE",
  51: "F_LOG2PHYS",
  52: "F_GETPATH",
  53: "F_FULLFSYNC",
  54: "F_PATHPKG_CHECK",
  55: "F_FREEZE_FS",
  56: "F_THAW_FS",
  57: "F_GLOBAL_NOCACHE",
  61: "F_ADDSIGS",
  62: "F_ADDFILESIGS",
  63: "F_NODIRECT",
  64: "F_GETPROTECTIONCLASS",
  65: "F_SETPROTECTIONCLASS",
  66: "F_LOG2PHYS_EXT",
  67: "F_GETLKPID",
  70: "F_SETBACKINGSTORE",
  71: "F_GETPATH_MTMINFO",
  72: "F_GETCODEDIR",
  73: "F_SETNOSIGPIPE",
  74: "F_GETNOSIGPIPE",
  75: "F_TRANSCODEKEY",
  76: "F_SINGLE_WRITER",
  77: "F_GETPROTECTIONLEVEL",
  78: "F_FINDSIGS",
  85: "F_ADDFILESIGS_FOR_DYLD_SIM",
  86: "F_BARRIERFSYNC",
  97: "F_ADDFILESIGS_RETURN",
  98: "F_CHECK_LV",
  99: "F_PUNCHHOLE",
  100: "F_TRIM_ACTIVE_FILE",
  101: "F_SPECULATIVE_READ",
  102: "F_GETPATH_NOFIRMLINK",
  103: "F_ADDFILESIGS_INFO",
  104: "F_ADDFILESUPPL",
  105: "F_GETSIGSINFO",
};

// Errno values
export const ERRNO_NAMES: Record<number, string> = {
  1: "EPERM",
  2: "ENOENT",
  3: "ESRCH",
  4: "EINTR",
  5: "EIO",
  6: "ENXIO",
  7: "E2BIG",
  8: "ENOEXEC",
  9: "EBADF",
  10: "ECHILD",
  11: "EDEADLK",
  12: "ENOMEM",
  13: "EACCES",
  14: "EFAULT",
  15: "ENOTBLK",
  16: "EBUSY",
  17: "EEXIST",
  18: "EXDEV",
  19: "ENODEV",
  20: "ENOTDIR",
  21: "EISDIR",
  22: "EINVAL",
  23: "ENFILE",
  24: "EMFILE",
  25: "ENOTTY",
  26: "ETXTBSY",
  27: "EFBIG",
  28: "ENOSPC",
  29: "ESPIPE",
  30: "EROFS",
  31: "EMLINK",
  32: "EPIPE",
  33: "EDOM",
  34: "ERANGE",
  35: "EAGAIN",
  36: "EINPROGRESS",
  37: "EALREADY",
  38: "ENOTSOCK",
  39: "EDESTADDRREQ",
  40: "EMSGSIZE",
  41: "EPROTOTYPE",
  42: "ENOPROTOOPT",
  43: "EPROTONOSUPPORT",
  44: "ESOCKTNOSUPPORT",
  45: "ENOTSUP",
  46: "EPFNOSUPPORT",
  47: "EAFNOSUPPORT",
  48: "EADDRINUSE",
  49: "EADDRNOTAVAIL",
  50: "ENETDOWN",
  51: "ENETUNREACH",
  52: "ENETRESET",
  53: "ECONNABORTED",
  54: "ECONNRESET",
  55: "ENOBUFS",
  56: "EISCONN",
  57: "ENOTCONN",
  58: "ESHUTDOWN",
  59: "ETOOMANYREFS",
  60: "ETIMEDOUT",
  61: "ECONNREFUSED",
  62: "ELOOP",
  63: "ENAMETOOLONG",
  64: "EHOSTDOWN",
  65: "EHOSTUNREACH",
  66: "ENOTEMPTY",
  67: "EPROCLIM",
  68: "EUSERS",
  69: "EDQUOT",
  70: "ESTALE",
  71: "EREMOTE",
  72: "EBADRPC",
  73: "ERPCMISMATCH",
  74: "EPROGUNAVAIL",
  75: "EPROGMISMATCH",
  76: "EPROCUNAVAIL",
  77: "ENOLCK",
  78: "ENOSYS",
  79: "EFTYPE",
  80: "EAUTH",
  81: "ENEEDAUTH",
  82: "EPWROFF",
  83: "EDEVERR",
  84: "EOVERFLOW",
  85: "EBADEXEC",
  86: "EBADARCH",
  87: "ESHLIBVERS",
  88: "EBADMACHO",
  89: "ECANCELED",
  90: "EIDRM",
  91: "ENOMSG",
  92: "EILSEQ",
  93: "ENOATTR",
  94: "EBADMSG",
  95: "EMULTIHOP",
  96: "ENODATA",
  97: "ENOLINK",
  98: "ENOSR",
  99: "ENOSTR",
  100: "EPROTO",
  101: "ETIME",
  102: "EOPNOTSUPP",
  103: "ENOPOLICY",
  104: "ENOTRECOVERABLE",
  105: "EOWNERDEAD",
  106: "EQFULL",
};

export function getSyscallName(num: number): string {
  return SYSCALL_NAMES[num] ?? `syscall_${num}`;
}

export function formatOpenFlags(flags: number): string {
  // Handle access mode first (special case: 0 = O_RDONLY)
  const accessMode = flags & O_ACCMODE;
  const parts: string[] = [];

  if (accessMode === 0) {
    parts.push("O_RDONLY");
  } else if (accessMode === 1) {
    parts.push("O_WRONLY");
  } else if (accessMode === 2) {
    parts.push("O_RDWR");
  }

  // Handle other flags (skip access mode bits)
  const otherFlags = flags & ~O_ACCMODE;
  for (const [value, name] of Object.entries(O_FLAGS)) {
    const numValue = Number(value);
    if (numValue > O_ACCMODE && (otherFlags & numValue) !== 0) {
      parts.push(name);
    }
  }

  return parts.join("|") || "0";
}

export function formatProtFlags(prot: number): string {
  if (prot === 0) return "PROT_NONE";

  const parts: string[] = [];
  if (prot & 0x01) parts.push("PROT_READ");
  if (prot & 0x02) parts.push("PROT_WRITE");
  if (prot & 0x04) parts.push("PROT_EXEC");

  return parts.join("|") || "0";
}

export function formatMapFlags(flags: number): string {
  const parts: string[] = [];

  // Shared vs private (mutually exclusive)
  if (flags & 0x0001) {
    parts.push("MAP_SHARED");
  } else if (flags & 0x0002) {
    parts.push("MAP_PRIVATE");
  }

  // Other flags
  if (flags & 0x0010) parts.push("MAP_FIXED");
  if (flags & 0x1000) parts.push("MAP_ANON");
  if (flags & 0x0400) parts.push("MAP_NOCACHE");

  return parts.join("|") || "0";
}

export function formatErrno(errno: number): string {
  const name = ERRNO_NAMES[errno];
  return name ? `-1 ${name} (${errno})` : `-1 (${errno})`;
}

export function formatFcntlCmd(cmd: number): string {
  return FCNTL_CMDS[cmd] ?? String(cmd);
}

export function formatPointer(ptr: number | bigint): string {
  if (ptr === 0 || ptr === 0n) return "NULL";
  const hex = typeof ptr === "bigint" ? ptr.toString(16) : ptr.toString(16);
  return `0x${hex}`;
}

export function formatString(s: string, maxLen = 32): string {
  if (s.length <= maxLen) {
    return JSON.stringify(s);
  }
  return JSON.stringify(s.slice(0, maxLen)) + "...";
}
